# VM

## Execution model

The VM executes a token stream in reading order. Each token is executed as:

```
Select → Bound → Seal
```

### Registers

Minimum required registers:

- `Ω`: ambient/root handle (always defined).
- `F`: current focus handle.
- `R`: last-residue handle (defaults to `⊥`).
- `K`: handle stack (LIFO).
- `E`: environment stack (scoping frames).
- `W`: watchlist or persistent selectors (optional but recommended).
- `OStack_word`: word-scoped obligation stack (LIFO).
- `τ`: step counter.

Initial state (before first token):

```
Ω := root scope handle
F := Ω
R := ⊥
K := [F, R]
W := []
OStack_word := []
τ := 0
```

## Operand selection policy

Each letter declares:

- `arity_req`, `arity_opt`
- `distinct_required`, `distinct_optional`
- `reflexive_ok`
- input/output handle kinds

Required operands are sourced **in order** from:

1. `K` (stack)
2. `W` (watchlist)
3. `F` (focus)
4. `R` (residue)
5. `Ω` (ambient)

Optional operands are supplied only if available without forcing duplicates.

### Underflow policy

If required operands are missing:

- If `reflexive_ok` is true, duplicate the last selected operand.
- Otherwise, fill with `⊥`.

If any filled operand violates the operator’s type signature, the program is ill-formed (compile error).

## Seal policy

`Seal` MUST:

- push `h_out` onto `K`
- set `F := h_out` in the current frame
- set `R := r_out`

`r_out` is total: every letter yields a residue; if none, use `⊥`.

## Space semantics (`□`)

Whitespace tokens execute the **space operator** and are also injected implicitly at the beginning and end of input.

Space behavior:

1. `τ := τ + 1`
2. Resolve **all** pending `OStack_word` obligations using boundary defaults.
3. Commit any buffered event batch to the event log.
4. Apply fixed stack discipline (implementation-defined but deterministic).
5. Optional GC: delete handles not reachable from roots `{Ω, F} ∪ K ∪ W ∪ {R}`.

## Obligations

Obligations are word-scoped and must be discharged in LIFO order.

```
OKind := { MEM_ZONE, SUPPORT } plus any additional kinds declared in `/registry/letters.yaml`.

Obligation := {
  kind: OKind,
  parent: handle_id,
  child: handle_id,
  payload: map,
  tau_created: int
}
```

Boundary defaults (required):

- `MEM_ZONE` → close silently; no export.
- `SUPPORT` → **fall**: log `fall(child,parent,τ)`, set `R := child`, `F := parent`.

Any additional obligation kinds MUST declare their boundary defaults in `/registry/letters.yaml` and in letter specs.

Non-LIFO discharge is a compile error.

## Deterministic error handling

Invalid inputs MUST fail with typed errors:

- Compile-time errors (tokenization/validation)
- Runtime errors (VM/semantics)

No silent fallback for unknown diacritics or invalid nesting.
